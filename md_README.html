<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>openMMC: openMMC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">openMMC
   </div>
   <div id="projectbrief">Open Source Modular MMC for AMCs</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_README.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">openMMC</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://github.com/lnls-dig/openMMC/actions"><img src="https://github.com/lnls-dig/openMMC/actions/workflows/build.yml/badge.svg" alt="Continuous Integration Status" style="pointer-events: none;" class="inline"/></a></p>
<p>Open Source modular IPM Controller firmware</p>
<p>Documentation: <a href="https://lnls-dig.github.io/openMMC">https://lnls-dig.github.io/openMMC</a></p>
<h1>Installation:</h1>
<p>The following packages are needed in your system in order to compile the firmware:</p><ul>
<li><b>gcc-arm-none-eabi</b></li>
<li><b>cmake</b></li>
<li><b>cmake-gui</b> (Optional)</li>
</ul>
<p><b>gcc-arm-none-eabi</b> can be installed from the pre-compiled files found at: <a href="https://launchpad.net/gcc-arm-embedded/+download">https://launchpad.net/gcc-arm-embedded/+download</a> or you can run the following command under Ubuntu: </p><pre class="fragment">sudo apt-get install gcc-arm-none-eabi
</pre><p> Next step is to clone this repository into your workspace. </p><pre class="fragment">git clone https://github.com/lnls-dig/openMMC
</pre> <h1>Compilation</h1>
<p>Create a new folder wherever is suitable </p><pre class="fragment">cd &lt;build_folder&gt;
</pre><p> Run CMake using the path to the repository folder as an direct argument and the flag <code>-DBOARD=&lt;board_name&gt;</code>(at this moment, only <code>afc</code> can be selected) ,<code>-DVERSION=&lt;board_version&gt;</code> (<code>3.1</code> or <code>4.0</code>) and <code>-DBOARD_RTM=&lt;rtm_name&gt;</code> (<code>8sfp</code> or <code>lamp</code>) to configure the compilation scripts to your specific board hardware. </p><pre class="fragment">cmake &lt;path_to_source&gt; -DBOARD=&lt;board_name&gt; -DVERSION=&lt;board_version&gt; -DBOARD_RTM=&lt;rtm_name&gt;
</pre><p> Example: </p><pre class="fragment">cmake ~/openmmc/ -DBOARD=afc -DVERSION=3.1 -DBOARD_RTM=8sfp
</pre><p> After creating the build files with CMake, you can compile the firmware using <code>make</code>, optionally setting the VERBOSE flag to 1 if you wish to see all the compilation commands </p><pre class="fragment">make [VERBOSE=1]
</pre><p> Both a <code>.elf</code> file and a <code>.bin</code> file will be generated in the <code>out</code> folder. You can use any one you prefer to program your processor.</p>
<p>To clean the compilation files (binaries, objects and dependence files), just run </p><pre class="fragment">make clean
</pre><p> To make a debug build (to include symbols into elf file, turn off optimizations, etc.) add <code>-DCMAKE_BUILD_TYPE=Debug</code> option to <code>cmake</code> command. Example: </p><pre class="fragment">cmake ~/openmmc/ -DBOARD=afc -DVERSION=3.1 -DCMAKE_BUILD_TYPE=Debug
</pre> <h1>Programming</h1>
<h2>OpenOCD</h2>
<p>Flashing the MMC microcontroller via SWD/JTAG is supported for CMSIS-DAP and Jlink compatible probes through OpenOCD. You can specify the debug probe with the flag <code>-DDEBUG_PROBE=&lt;probe_name&gt;</code>, valid options are <code>cmsis-dap</code> (default), <code>jlink</code>, <code>digilent_jtag_hs3</code> and <code>xvc</code> (support is not merged to the official OpenOCD source yet, so you build our patched version: <a href="https://github.com/lnls-dig/openocd/tree/fix-afcv3-flashing">https://github.com/lnls-dig/openocd/tree/fix-afcv3-flashing</a>). </p><pre class="fragment">cmake ~/openmmc/ -DBOARD=afc -DVERSION=3.1 -DDEBUG_PROBE=cmsis-dap
</pre><p> This will create a <code>openocd.cfg</code> file in <code>&lt;build_dir&gt;/out</code>.</p>
<p>To flash the application firmware only, run </p><pre class="fragment">make program_app
</pre><p> To flash the bootloader firmware only, run </p><pre class="fragment">make program_boot
</pre><p> If you want to erase the whole Flash and flash both firmwares: </p><pre class="fragment">make program_all
</pre> <h2>LPC-Link1</h2>
<p>It is possible to flash the MMC microcontroller with the LPC-Link1 adapter by using the <code>probe/lpclink1-flash.sh</code> script. You will need to have MCUXpresso IDE installed in your computer. This script assumes that the MCUXpresso binaries are located in <code>/usr/local/mcuxpressoide/ide/binaries/</code> by default, you can change this path by setting the <code>MCUXPRESSOIDE_BIN</code> environment variable. </p><pre class="fragment">./probe/lpclink1-flash.sh firmware.bin LPC1764 0x0000
</pre> <h2>HPM-Downloader</h2>
<blockquote class="doxtable">
<p>&zwj;:warning: <b>Disclaimer:</b> Due to <a href="https://github.com/lnls-dig/openMMC/commit/f06f69f978c11bb8e1a2b12e4846e4bd51f757e4">f06f69f</a>, this alternative is deprecated and ipmitool should be used instead, except when updating the OpenMMC application from older versions. </p>
</blockquote>
<p>Another option to program the MMC microcontroler is through <a href="https://github.com/lnls-dig/hpm-downloader">HPM-Downloader</a>. First, download and compile the HPM. In it's root directory, in order to load the firmware, run </p><pre class="fragment">./bin/hpm-downloader --no-retries --ip &lt;MCH_IP_address&gt; --slot &lt;slots_to_be_updated&gt; --component 1 &lt;path_to_openMMC.bin&gt;
</pre><p> Due to timeout on sending packets, it may fails sometimes, with the Completion Code <code>0xc3</code> in the <code>ACTIVATE_FIRMWARE_UPLOAD</code> process. If it occurs, just try the same command again, until you receive the <code>Upgrade success</code> message. Now, you have to upload the bootloader, since the old bootloader is incompatible. To succeed this, run </p><pre class="fragment"> ./bin/hpm-downloader --ignore-component-check --ip &lt;MCH_IP_address&gt; --slot &lt;slots_to_be_updated&gt; --component 0 &lt;path_to_newboot.bin&gt;
</pre><p> It's also important to mention that you can use the <code>--help</code> command in case of doubt about how to use the HPM commands. Run </p><pre class="fragment">./bin/hpm-downloader --help
</pre> <h2>ipmitool</h2>
<blockquote class="doxtable">
<p>&zwj;:warning: <b>Disclaimer:</b> Due to <a href="https://github.com/lnls-dig/openMMC/tree/e88b30b26c9dc05662d84e35b51fc81d7ecf7561">e88b30b</a>, the ipmitool may fail when trying to upgrade the firmware from v1.5.0. You can use a modified ipmitool utility as a workaround, setting the variable <a href="https://codeberg.org/IPMITool/ipmitool/src/commit/137aeb64cbb493d61d6945cac156aba5f0510780/lib/ipmi_hpmfwupg.c#L1143"><code>max_rq_size</code></a> to 20. </p>
</blockquote>
<p>After <a href="https://github.com/lnls-dig/openMMC/commit/563185791c8b51ea026680c98ec0ea9587ea645b">5631857</a>, it's possible to program the firmware and the bootloader through <a href="https://codeberg.org/IPMITool/ipmitool">ipmitool</a>, for previous releases, you still need to use <a href="https://github.com/lnls-dig/hpm-downloader">hpm-downloader</a>. In order to use it, you have to install the ipmitool, and then generate .hpm files from <code>OpenMMC.bin</code> and <code>newboot.bin</code>. To generate <code>.hpm</code> files, you will need to use <a href="https://github.com/MicroTCA-Tech-Lab/bin2hpm">bin2hpm</a>. If you have bin2hpm in your <code>$PATH</code>, the <code>.hpm</code> files will be automatically generated for you, provided you build from <a href="https://github.com/lnls-dig/openMMC/commit/0095b14667afe844113725228671d8810b45d9e0">0095b14</a> or more recent versions. After generate the files, you can use the following commands to program the MMC microcontroller. To upgrade the firmware, use </p><pre class="fragment">ipmitool -I lan -H host_name_mch -A none -T 0x82 -m 0x20 -t (112 + num_slot*2 in hexadecimal) hpm upgrade openMMC.hpm activate
</pre><p> To upgrade the bootloader, use </p><pre class="fragment">ipmitool -I lan -H host_name_mch -A none -T 0x82 -m 0x20 -t (112 + num_slot*2 in hexadecimal) hpm upgrade newboot.hpm activate
</pre> <h2>nxpprog</h2>
<blockquote class="doxtable">
<p>&zwj;:warning: <b>Disclaimer:</b> Only supported in AFCv4.0.2 </p>
</blockquote>
<p>In AFCv4, it's possible to program the firmware and bootloader via serial port using <a href="https://github.com/lnls-dig/nxpprog">nxpprog</a>. In order to use it, install nxpprog and then execute the following commands: To upgrade the application, use </p><pre class="fragment">./nxpprog.py  &lt;serial_device&gt; &lt;path_to_openMMC.bin&gt; --addr 0x20000 --control
</pre><p> To upgrade the bootloader, use </p><pre class="fragment">./nxpprog.py  &lt;serial_device&gt; &lt;path_to_newboot.bin&gt; --control
</pre> <h1>Debugging</h1>
<p>It is possible to debug the MMC firmware using OpenOCD and GDB. First, connect OpenOCD with the debug probe using the <code>out/openocd.cfg</code> file generated by cmake in the build directory: </p><pre class="fragment">openocd -f out/openocd.cfg
</pre><p> Then open GDB: </p><pre class="fragment">$ arm-none-eabi-gdb out/openMMC.elf
(gdb) target remote localhost:3333
</pre><p> Now you can use the typical GDB commands to inspect the program flow and variables. Some useful commands when interacting with a microcontroller trough OpenOCD are listed below: </p><pre class="fragment">(gdb) monitor reset halt # Resets the microcontroller and immediately halts
(gdb) monitor reset run  # Resets the microcontroller and starts executing
(gdb) load               # Reload the firmware into flash
</pre><h1>IPMI Custom Commands</h1>
<p>The IPMI allow us to create custom commands according to the project needs. <a href="https://codeberg.org/IPMITool/ipmitool">ipmitool</a> can be used to send the commands</p>
<h2>Get free heap memory</h2>
<p>It is possible to monitor the MMC's memory usage via IPMI. To obtain the total free heap use command 0x01, netfn_id 0x32. The returned data will be the number of free heap bytes, encoded as a 32 bits unsigned integer, little-endian. </p><pre class="fragment">ipmitool -I lan -H mch_host_name -A none -T 0x82 -m 0x20 -t (112 + num_slot*2) raw 0x32 0x01
</pre> <h2>Commit Hash read</h2>
<p>After loading a new firmware, you can use an ipmi command to read its commit hash to ensure that the running version is the one you want. The command is the above:</p>
<pre class="fragment">ipmitool -I lan -H mch_host_name -A none -T 0x82 -m 0x20 -t (112 + num_slot*2) raw 0x32 0x02
</pre> <h2>Clock switch configuration</h2>
<p>After <a href="https://github.com/lnls-dig/openMMC/tree/7a91948975f87f6613b28fc1ea562a2a7bb3c475">7a919489</a> the clock switch configuration is no longer hardcoded for each board. Instead, it must be configured through an IPMI command.</p>
<p>For the AFC v3.1 (ADN4604ASVZ) you can use the <a href="/scripts/afcv3.1-clksw-config.py">script</a> for generate the configuration, and use the json configuration for <a href="/config/lnls/afcv3.1-bpm-clk-cfg.json">AFCv3.1-BPM</a> or <a href="/config/lnls/afcv3.1-timing-clk-cfg.json">AFCv3.1-Timing</a>. If you want to generate a new configuration, use the following scheme:</p><ul>
<li><b>Port I/O (bit 7)</b>: Use it to configure the port as an input ('0') or output ('1'). Unused ports should be left configured as inputs;</li>
<li><b>Output Port Signal Source (bits 0 to 3)</b>: Select the input port for the respective output port.</li>
</ul>
<p>For the AFC v4 (IDT 8V54816) you can use the following scheme: For the AFC v4.0 (IDT 8V54816) you can use the <a href="/scripts/afcv4-clksw-config.py">script</a> for generate the configuration, and use the json configuration for <a href="/config/lnls/afcv4-fofb-clk-cfg.json">AFCv4.0-FOFB</a>. If you want to generate a new configuration, use the following scheme:</p><ul>
<li><b>Port I/O (bit 7)</b>: Use it to configure the port as an input ('0') or output ('1'). Unused ports should be left configured as inputs;</li>
<li><b>Termination On/Off (bit 6)</b>: Use to set the internal termination. '0' is off (high-impedance), '1' is on (100 $\Omega$)</li>
<li><b>Polarity (bit 5)</b>: Set the channel polarity. '0' for inverted, '1' for non-inverted</li>
<li><b>Output Port Signal Source (bits 0 to 3)</b>: Select the input port for the respective output port.</li>
</ul>
<p>The command to write the configuration is the above: </p><pre class="fragment">ipmitool -I lan -H mch_host_name -A none -T 0x82 -m 0x20 -t (112 + num_slot*2) raw 0x32 0x03 &lt;configuration_array_in_hex&gt;
</pre><p> To read the actual configuration, use: </p><pre class="fragment">ipmitool -I lan -H mch_host_name -A none -T 0x82 -m 0x20 -t (112 + num_slot*2) raw 0x32 0x04
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Jul 24 2024 08:15:57 for openMMC by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
