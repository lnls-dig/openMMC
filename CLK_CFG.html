<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>openMMC: Clock Routing Configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">openMMC
   </div>
   <div id="projectbrief">Open Source Modular MMC for AMCs</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('CLK_CFG.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Clock Routing Configuration</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#CLK_CFG_SCHROFF">Clock configuration on Schroff crate with NAT MCH</a><ul><li class="level2"><a href="#CLK_CFG_SCHROFF_AFC">AFC Configuration</a></li>
<li class="level2"><a href="#CLK_CFG_SCHROFF_MCH">MCH Configuration</a><ul><li class="level3"><a href="#CLK_CFG_SCHROFF_MCH_NAT">NAT MCH</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="CLK_CFG_SCHROFF"></a>
Clock configuration on Schroff crate with NAT MCH</h1>
<p>Guide to configure the clock switching inside the uTCA crate (NAT MCH + Schroff Crate + AFC board)</p>
<h2><a class="anchor" id="CLK_CFG_SCHROFF_AFC"></a>
AFC Configuration</h2>
<p>The AFC board has a crossbar clock switch that is configured upon payload activation (Hotswap handle pressed - Blue LED off).</p>
<p>The outputs configuration is defined inside the file openMMC/port/board/&lt;board-name&gt;/adn4604_usercfg.h .</p>
<p>In this file you can change the clock outputs (ADN4604_CFG_OUT_n). For example: </p><div class="fragment"><div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_0       0      </span><span class="comment">// TCLKD_OUT</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_1       0      </span><span class="comment">// TCLKC_OUT</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_2       0      </span><span class="comment">// TCLKA_OUT</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_3       0      </span><span class="comment">// TCLKB_OUT</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_4       13     </span><span class="comment">// FPGA_CCLK</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_5       8      </span><span class="comment">// FP2_CLK2</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_6       8      </span><span class="comment">// LINK01_CLK</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_7       8      </span><span class="comment">// FP2_CLK1</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_8       8      </span><span class="comment">// PCIE_CLK1</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_9       8      </span><span class="comment">// LINK23_CLK</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_10      14     </span><span class="comment">// FIN1_CLK3</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_11      14     </span><span class="comment">// FIN1_CLK2</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_12      14     </span><span class="comment">// RTM_SYNC_CLK</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_13      5      </span><span class="comment">// OP15C (Aux U-Fl connector)</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_14      14     </span><span class="comment">// FIN2_CLK2</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_CFG_OUT_15      14     </span><span class="comment">// FIN2_CLK3</span></div>
</div><!-- fragment --><p>You must also set (in the same header) which outputs will be enabled. To do that, just set the corresponding output enable flag (ADN4604_EN_OUT_n) to 1, like the following:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_0        0       </span><span class="comment">// TCLKD_OUT</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_1        0       </span><span class="comment">// TCLKC_OUT</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_2        0       </span><span class="comment">// TCLKA_OUT</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_3        0       </span><span class="comment">// TCLKB_OUT</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_4        1       </span><span class="comment">// FPGA_CCLK</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_5        1       </span><span class="comment">// FP2_CLK2</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_6        1       </span><span class="comment">// LINK01_CLK</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_7        1       </span><span class="comment">// FP2_CLK1</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_8        1       </span><span class="comment">// PCIE_CLK1</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_9        1       </span><span class="comment">// LINK23_CLK</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_10       1       </span><span class="comment">// FIN1_CLK3</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_11       1       </span><span class="comment">// FIN1_CLK2</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_12       0       </span><span class="comment">// RTM_SYNC_CLK</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_13       1       </span><span class="comment">// OP15C (Aux U-Fl connector)</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_14       1       </span><span class="comment">// FIN2_CLK2</span></div>
<div class="line"><span class="preprocessor">#define ADN4604_EN_OUT_15       1       </span><span class="comment">// FIN2_CLK3</span></div>
</div><!-- fragment --><h2><a class="anchor" id="CLK_CFG_SCHROFF_MCH"></a>
MCH Configuration</h2>
<p>In order to receive the clock in the AFC board, the signal must be available in one of the uTCA user clock lanes (TCLKA-D) and be correctly switched to the AFC board (the MCH uses a star topology to connect the clocks to the AFCs).</p>
<h3><a class="anchor" id="CLK_CFG_SCHROFF_MCH_NAT"></a>
NAT MCH</h3>
<dl class="section note"><dt>Note</dt><dd>This configuration is only needed if you'll use the MCH internal clock switching feature. If your clock has already been routed directly to the TCLK lanes of the AMCs, you're good to go</dd></dl>
<p>The NAT Clock switch is configured using a text file that'll be parsed by the FPGA. In this file all the clock connection are defined (source, destination). A default configuration file can be obtained on the MCH webserver, under the <code>Script Management</code> menu.</p>
<p>The user clocks are treated here by different names: </p><div class="fragment"><div class="line"><a class="code hl_define" href="fru__editor_8h.html#aa76998bd12511907298ce96d011395e9">TCLKA</a>/C -&gt; CLK1</div>
<div class="line"><a class="code hl_define" href="fru__editor_8h.html#a4947af5588670689244a391d295db86f">TCLKB</a>/D -&gt; CLK2</div>
<div class="line"><a class="code hl_define" href="fru__editor_8h.html#ac705c4436179e89b59738492408f9cad">FCLKA</a>   -&gt; CLK3</div>
<div class="ttc" id="afru__editor_8h_html_a4947af5588670689244a391d295db86f"><div class="ttname"><a href="fru__editor_8h.html#a4947af5588670689244a391d295db86f">TCLKB</a></div><div class="ttdeci">#define TCLKB</div><div class="ttdef"><b>Definition</b> fru_editor.h:61</div></div>
<div class="ttc" id="afru__editor_8h_html_aa76998bd12511907298ce96d011395e9"><div class="ttname"><a href="fru__editor_8h.html#aa76998bd12511907298ce96d011395e9">TCLKA</a></div><div class="ttdeci">#define TCLKA</div><div class="ttdef"><b>Definition</b> fru_editor.h:60</div></div>
<div class="ttc" id="afru__editor_8h_html_ac705c4436179e89b59738492408f9cad"><div class="ttname"><a href="fru__editor_8h.html#ac705c4436179e89b59738492408f9cad">FCLKA</a></div><div class="ttdeci">#define FCLKA</div><div class="ttdef"><b>Definition</b> fru_editor.h:64</div></div>
</div><!-- fragment --><p>To configure the clock switching, download the current configuration file and search for the line <code>clk_phys_out = dst, src</code> Here you can edit the source for each destination, for example, if you want to route the TCLKB from AMC3 to TCLKA from AMC4 one will write: </p><div class="fragment"><div class="line">clk_phys_out = 4, 19</div>
</div><!-- fragment --><p>Keep in mind that one MCH only has access to one pair of TCLK signals, either TCLKA and TCLKB or TCLKC and TCLKD. The other pair is routed to the redundant MCH slot.</p>
<p>After editing the needed options, save the file and upload it using the Webserver feature. Here you can choose to overwrite the startup default configuration with your new file, if you don't select this option your changes will be lost on the next reboot. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Jul 24 2024 08:15:57 for openMMC by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
